"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var module_loader_exports = {};
__export(module_loader_exports, {
  patchModuleLoader: () => patchModuleLoader
});
module.exports = __toCommonJS(module_loader_exports);
var import_astro_sys = require("./astro-sys.js");
var import_utils = require("./utils.js");
class ModuleResolutionCache {
  constructor() {
    this.cache = /* @__PURE__ */ new Map();
  }
  get(moduleName, containingFile) {
    return this.cache.get(this.getKey(moduleName, containingFile));
  }
  set(moduleName, containingFile, resolvedModule) {
    if (!resolvedModule) {
      return;
    }
    this.cache.set(this.getKey(moduleName, containingFile), resolvedModule);
  }
  delete(resolvedModuleName) {
    this.cache.forEach((val, key) => {
      if (val.resolvedFileName === resolvedModuleName) {
        this.cache.delete(key);
      }
    });
  }
  getKey(moduleName, containingFile) {
    return containingFile + ":::" + (0, import_utils.ensureRealAstroFilePath)(moduleName);
  }
}
function patchModuleLoader(logger, snapshotManager, typescript, lsHost, project) {
  var _a, _b;
  const astroSys = (0, import_astro_sys.createAstroSys)(logger);
  const moduleCache = new ModuleResolutionCache();
  const origResolveModuleNames = (_a = lsHost.resolveModuleNames) == null ? void 0 : _a.bind(lsHost);
  const origResolveModuleNamLiterals = (_b = lsHost.resolveModuleNameLiterals) == null ? void 0 : _b.bind(lsHost);
  if (lsHost.resolveModuleNameLiterals) {
    lsHost.resolveModuleNameLiterals = resolveModuleNameLiterals;
  } else {
    lsHost.resolveModuleNames = resolveModuleNames;
  }
  const origRemoveFile = project.removeFile.bind(project);
  project.removeFile = (info, fileExists, detachFromProject) => {
    logger.log("File is being removed. Delete from cache: ", info.fileName);
    moduleCache.delete(info.fileName);
    return origRemoveFile(info, fileExists, detachFromProject);
  };
  const origReadDirectory = project.readDirectory.bind(project);
  project.readDirectory = (path, extensions, exclude, include, depth) => {
    const extensionsWithAstro = (extensions != null ? extensions : []).concat(".astro", ".md", ".mdx");
    return origReadDirectory(path, extensionsWithAstro, exclude, include, depth);
  };
  function resolveModuleNames(moduleNames, containingFile, reusedNames, redirectedReference, compilerOptions) {
    const resolved = (origResolveModuleNames == null ? void 0 : origResolveModuleNames(moduleNames, containingFile, reusedNames, redirectedReference, compilerOptions)) || Array.from(Array(moduleNames.length));
    return resolved.map((moduleName, idx) => {
      const fileName = moduleNames[idx];
      if (moduleName || !(0, import_utils.ensureRealAstroFilePath)(fileName).endsWith(".astro")) {
        return moduleName;
      }
      const cachedModule = moduleCache.get(fileName, containingFile);
      if (cachedModule) {
        return cachedModule;
      }
      const resolvedModule = resolveModuleName(fileName, containingFile, compilerOptions);
      moduleCache.set(fileName, containingFile, resolvedModule);
      return resolvedModule;
    });
  }
  function resolveModuleName(name, containingFile, compilerOptions) {
    const astroResolvedModule = typescript.resolveModuleName(
      name,
      containingFile,
      compilerOptions,
      astroSys
    ).resolvedModule;
    if (!astroResolvedModule || !(0, import_utils.isVirtualAstroFilePath)(astroResolvedModule.resolvedFileName)) {
      return astroResolvedModule;
    }
    const resolvedFileName = (0, import_utils.ensureRealAstroFilePath)(astroResolvedModule.resolvedFileName);
    logger.log("Resolved", name, "to astro file", resolvedFileName);
    const snapshot = snapshotManager.create(resolvedFileName);
    if (!snapshot) {
      return void 0;
    }
    const resolvedAstroModule = {
      extension: typescript.Extension.Tsx,
      resolvedFileName
    };
    return resolvedAstroModule;
  }
  function resolveModuleNameLiterals(moduleLiterals, containingFile, redirectedReference, options, containingSourceFile, reusedNames) {
    var _a2;
    logger.log("Resolving modules names for " + containingFile);
    const resolved = (_a2 = origResolveModuleNamLiterals == null ? void 0 : origResolveModuleNamLiterals(
      moduleLiterals,
      containingFile,
      redirectedReference,
      options,
      containingSourceFile,
      reusedNames
    )) != null ? _a2 : moduleLiterals.map(
      () => ({
        resolvedModule: void 0
      })
    );
    return resolved.map((tsResolvedModule, idx) => {
      const moduleName = moduleLiterals[idx].text;
      if (tsResolvedModule.resolvedModule || !(0, import_utils.ensureRealAstroFilePath)(moduleName).endsWith(".astro")) {
        return tsResolvedModule;
      }
      return resolveAstroModuleNameFromCache(moduleName, containingFile, options);
    });
  }
  function resolveAstroModuleNameFromCache(moduleName, containingFile, options) {
    const cachedModule = moduleCache.get(moduleName, containingFile);
    if (cachedModule) {
      return {
        resolvedModule: cachedModule
      };
    }
    const resolvedModule = resolveModuleName(moduleName, containingFile, options);
    moduleCache.set(moduleName, containingFile, resolvedModule);
    return {
      resolvedModule
    };
  }
}
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {
  patchModuleLoader
});
//# sourceMappingURL=data:application/json;base64,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QUFXO0FBQUEsTUFDdEM7QUFBQSxNQUNBO0FBQUEsTUFDQTtBQUFBLE1BQ0E7QUFBQSxJQUNELEVBQUU7QUFDRixRQUFJLENBQUMsdUJBQXVCLEtBQUMscUNBQXVCLG9CQUFvQixnQkFBZ0IsR0FBRztBQUMxRixhQUFPO0FBQUEsSUFDUjtBQUVBLFVBQU0sdUJBQW1CLHNDQUF3QixvQkFBb0IsZ0JBQWdCO0FBQ3JGLFdBQU8sSUFBSSxZQUFZLE1BQU0saUJBQWlCLGdCQUFnQjtBQUM5RCxVQUFNLFdBQVcsZ0JBQWdCLE9BQU8sZ0JBQWdCO0FBQ3hELFFBQUksQ0FBQyxVQUFVO0FBQ2QsYUFBTztBQUFBLElBQ1I7QUFFQSxVQUFNLHNCQUE2QztBQUFBLE1BQ2xELFdBQVcsV0FBVyxVQUFVO0FBQUEsTUFDaEM7QUFBQSxJQUNEO0FBQ0EsV0FBTztBQUFBLEVBQ1I7QUFFQSxXQUFTLDBCQUNSLGdCQUNBLGdCQUNBLHFCQUNBLFNBQ0Esc0JBQ0EsYUFDd0Q7QUE3SjFELFFBQUFBO0FBOEpFLFdBQU8sSUFBSSxpQ0FBaUMsY0FBYztBQUsxRCxVQUFNLFlBQ0xBLE1BQUE7QUFBQSxNQUNDO0FBQUEsTUFDQTtBQUFBLE1BQ0E7QUFBQSxNQUNBO0FBQUEsTUFDQTtBQUFBLE1BQ0E7QUFBQSxVQU5ELE9BQUFBLE1BUUEsZUFBZTtBQUFBLE1BQ2QsT0FBbUQ7QUFBQSxRQUNsRCxnQkFBZ0I7QUFBQSxNQUNqQjtBQUFBLElBQ0Q7QUFFRCxXQUFPLFNBQVMsSUFBSSxDQUFDLGtCQUFrQixRQUFRO0FBQzlDLFlBQU0sYUFBYSxlQUFlLEtBQUs7QUFDdkMsVUFBSSxpQkFBaUIsa0JBQWtCLEtBQUMsc0NBQXdCLFVBQVUsRUFBRSxTQUFTLFFBQVEsR0FBRztBQUMvRixlQUFPO0FBQUEsTUFDUjtBQUVBLGFBQU8sZ0NBQWdDLFlBQVksZ0JBQWdCLE9BQU87QUFBQSxJQUMzRSxDQUFDO0FBQUEsRUFDRjtBQUVBLFdBQVMsZ0NBQWdDLFlBQW9CLGdCQUF3QixTQUE2QjtBQUNqSCxVQUFNLGVBQWUsWUFBWSxJQUFJLFlBQVksY0FBYztBQUMvRCxRQUFJLGNBQWM7QUFDakIsYUFBTztBQUFBLFFBQ04sZ0JBQWdCO0FBQUEsTUFDakI7QUFBQSxJQUNEO0FBRUEsVUFBTSxpQkFBaUIsa0JBQWtCLFlBQVksZ0JBQWdCLE9BQU87QUFDNUUsZ0JBQVksSUFBSSxZQUFZLGdCQUFnQixjQUFjO0FBQzFELFdBQU87QUFBQSxNQUNOO0FBQUEsSUFDRDtBQUFBLEVBQ0Q7QUFDRDsiLAogICJuYW1lcyI6IFsiX2EiXQp9Cg==
